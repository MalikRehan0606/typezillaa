
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isNewUser() {
    	return !exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Global stats can be read by anyone, but only updated via trusted operations (e.g. cloud functions or specific writes)
    match /globalStats/{statId} {
      allow read: if true;
      allow write: if isSignedIn(); // For incrementing, checked in client logic
    }
    
    match /users/{userId} {
      allow read: if true;
      // Allow creation only for new users, and update only for the owner of the document.
      allow write: if isOwner(userId);
    }
    
    match /users/{userId}/testHistory/{testId} {
        allow read, write: if isOwner(userId);
    }

    match /leaderboard/{docId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // Leaderboard entries are immutable
    }
    
    match /passwordResetAttempts/{email} {
        allow read, write: if true; // Open for now to allow client to check attempts
    }

    match /matches/{matchId} {
        allow read: if true;
        // Only authenticated users can create matches
        // Additional checks (daily limits) are done in rules and client
        allow create: if isSignedIn()
                      && request.resource.data.player1Id == request.auth.uid
                      && request.resource.data.status == 'pending';
                      
        allow update: if isSignedIn(); // Allow players to update status, results, etc.
    }
    
    match /friendRequests/{requestId} {
        allow read: if isSignedIn();
        // Allow creation if the sender is the current user
        allow create: if isSignedIn() && request.resource.data.fromUserId == request.auth.uid;
        // Allow updates (accept/decline) by the recipient
        allow update: if isSignedIn() && resource.data.toUserId == request.auth.uid;
        // Deleting requests is not allowed to prevent losing request history
        allow delete: if false;
    }

    match /reports/{reportId} {
      allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      allow read, update, delete: if false; // Only admins can access reports
    }
  }
}
